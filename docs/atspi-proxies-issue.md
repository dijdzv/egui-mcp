# atspi-proxies `ProxyExt` Interface Conversion Issue

This document describes an issue we encountered with the `atspi-proxies` crate and its resolution.

## Problem

When using `Proxies::*()` methods from `atspi-proxies` v0.9.0, AT-SPI interface calls fail with errors like:
- "Unknown property 'CurrentValue'" (Value interface)
- "Unknown method 'DoAction'" (Action interface)
- "Unknown property 'CharacterCount'" (Text interface)

## Root Cause

The `Proxies::*()` methods in `atspi-proxies` use `*Proxy::from(self.proxy.clone())` to create interface proxies:

```rust
// atspi-proxies/src/proxy_ext.rs (v0.9.0)
pub fn action(&mut self) -> Result<&mut ActionProxy<'a>> {
    if self.interfaces.contains(Interface::Action) {
        let proxy_ref = self
            .inner
            .action
            .get_or_insert_with(|| ActionProxy::from(self.proxy.clone()));
        //                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        //                         This doesn't change the D-Bus interface!
        Ok(proxy_ref)
    } else {
        Err(AtspiError::InterfaceNotAvailable("Action"))
    }
}
```

The `From<zbus::Proxy>` implementation (generated by `zbus_macros`) does **not** change the interface name. The original proxy's interface (`org.a11y.atspi.Accessible`) is preserved, causing D-Bus calls to use the wrong interface.

## Existing Issue & Fix

This issue was already reported and fixed in the atspi repository:

- **Issue**: [#237 - `ProxyExt` does not convert `AccessibleProxy` into valid other proxies](https://github.com/odilia-app/atspi/issues/237)
- **Fix**: [PR #239 - fix (proxies): make `ProxyExt` convert into valid proxies](https://github.com/odilia-app/atspi/pull/239)
- **Merged**: April 25, 2025

The fix changes `Proxies::*()` to use `*Proxy::builder()` instead of `*Proxy::from()`:

```rust
// Fixed implementation uses builder with correct interface
ActionProxy::builder(conn)
    .destination(destination)?
    .path(path)?
    .build()
    .await?
```

## Version Information

| Crate | Our Version | Latest Version | Fix Included |
|-------|-------------|----------------|--------------|
| atspi-proxies | 0.9.0 | 0.13.0 | ✅ Yes (0.10+) |
| atspi-connection | 0.9.0 | 0.13.0 | ✅ Yes |
| atspi-common | 0.9.0 | 0.13.0 | N/A |

## Dependency Constraint

We cannot simply upgrade to atspi-* 0.13.0 because `accesskit_unix` (used by egui) depends on atspi 0.25.0 which uses atspi-proxies 0.9.0:

```
accesskit_unix v0.17.2
└── atspi v0.25.0
    ├── atspi-connection v0.9.0
    │   └── atspi-proxies v0.9.0  ← Fixed version not available
    └── atspi-proxies v0.9.0
```

## Our Workaround

In `egui-mcp-server`, we use `*Proxy::builder()` directly instead of `Proxies::*()`:

```rust
// Instead of:
let mut proxies = proxy.proxies().await?;
match proxies.value() {
    Ok(value_proxy) => { ... }
    Err(e) => { ... }
}

// We use:
use atspi_proxies::value::ValueProxy;
let value_proxy = ValueProxy::builder(self.connection.connection())
    .destination(destination.as_str())?
    .path(path.as_str())?
    .build()
    .await?;
```

This workaround is applied to all AT-SPI interface methods:
- Value: `get_value`, `set_value`
- Action: `click_element`
- Component: `get_bounds`, `focus_element`, `scroll_to_element`
- Text: `get_text`, `get_text_selection`, `set_text_selection`, `get_caret_position`, `set_caret_position`
- Selection: `select_item`, `deselect_item`, `get_selected_count`, `select_all`, `clear_selection`
- EditableText: `set_text`

## Issue 2: Method Name Case Mismatch (GetNSelections)

Another bug in atspi-proxies 0.9.0 is an incorrect method name case:

- **AT-SPI specification**: `GetNSelections` (capital S)
- **atspi-proxies**: `GetNselections` (lowercase s)

This causes "Unknown method 'GetNselections'" errors when calling `text_proxy.get_nselections()`.

### Workaround

We call the D-Bus method directly with the correct name:

```rust
// Instead of:
let n_selections = text_proxy.get_nselections().await?;

// We use:
let n_selections: i32 = text_proxy
    .inner()
    .call_method("GetNSelections", &())
    .await?
    .body()
    .deserialize()?;
```

---

## Future Resolution

When `accesskit_unix` updates its atspi dependency to a version that includes PR #239, we can:
1. Remove our workaround
2. Use the idiomatic `Proxies::*()` API
3. Simplify our code

### egui PR #7850

[egui PR #7850](https://github.com/emilk/egui/pull/7850) updates atspi from 0.25.0 to 0.28.0, which includes atspi-proxies 0.10+ with the fixes. Once this PR is merged and we update our egui dependency, our workarounds will become unnecessary.

## Related Links

- [odilia-app/atspi](https://github.com/odilia-app/atspi) - AT-SPI Rust bindings
- [Issue #237](https://github.com/odilia-app/atspi/issues/237) - Original bug report
- [PR #239](https://github.com/odilia-app/atspi/pull/239) - Fix merged April 2025
- [zbus](https://github.com/dbus2/zbus) - D-Bus library for Rust
